<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Чат</title>
    <style>
        body { font-family: Arial; background: #e3f5dc; padding: 20px; }
        input, button, select { margin: 5px; padding: 5px; }
        ul { list-style-type: none; padding: 0; }
        li { padding: 8px; border: 1px solid green; margin: 5px 0; cursor: pointer; }
    </style>
</head>
<body>

    <h2>Создать чат</h2>
    <select id="chat-type">
        <option value="private">Приватный</option>
        <option value="group">Групповой</option>
    </select>
    <input type="text" id="chat-name" placeholder="Название (для группы)">
    <input type="text" id="participant-ids" placeholder="ID участников через запятую">
    <button onclick="createChat()">Создать</button>

    <hr>

    <h2>Чаты</h2>
    <ul id="chat-list"></ul>

    <h2>Сообщения</h2>
    <ul id="message-list"></ul>
    <input type="text" id="message-input" placeholder="Ваше сообщение">
    <button id="send-message">Отправить</button>

    <script>
        let currentChatId = null;

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        async function createChat() {
            const chatType = document.getElementById('chat-type').value.toLowerCase();
            const name = document.getElementById('chat-name').value;
            const rawIds = document.getElementById('participant-ids').value;
            const participant_ids = rawIds.split(',').map(id => parseInt(id.trim())).filter(Boolean);

            const data = { chat_type: chatType, participant_ids };
            if (chatType === 'group') data.name = name;

            const response = await fetch('/api/chats/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                credentials: 'same-origin',
                body: JSON.stringify(data)
            });

            if (response.ok) {
                await loadChats();
                alert("Чат создан");
            } else {
                const err = await response.json();
                alert("Ошибка создания чата: " + JSON.stringify(err));
            }
        }

        async function loadChats() {
            const response = await fetch('/api/chats/', {
                credentials: 'same-origin',
            });

            if (response.ok) {
                const chats = await response.json();
                const chatList = document.getElementById('chat-list');
                chatList.innerHTML = '';
                chats.forEach(chat => {
                    const li = document.createElement('li');
                    li.textContent = chat.name || `Чат №${chat.id}`;
                    li.onclick = () => loadMessages(chat.id);
                    chatList.appendChild(li);
                });
            } else {
                alert('Ошибка при загрузке чатов');
            }
        }

        async function loadMessages(chatId) {
            currentChatId = chatId;
            const response = await fetch(`/api/messages/?chat=${chatId}`, {
                credentials: 'same-origin',
            });

            if (response.ok) {
                const messages = await response.json();
                const messageList = document.getElementById('message-list');
                messageList.innerHTML = '';
                messages.forEach(msg => {
                    const li = document.createElement('li');
                    li.textContent = `${msg.sender}: ${msg.content}`;
                    messageList.appendChild(li);
                });
            } else {
                alert('Ошибка при загрузке сообщений');
            }
        }

        async function sendMessage() {
            const content = document.getElementById('message-input').value;
            if (!content.trim() || !currentChatId) return;

            const response = await fetch('/api/messages/', {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({
                    chat: currentChatId,
                    content
                })
            });

            if (response.ok) {
                document.getElementById('message-input').value = '';
                await loadMessages(currentChatId);
            } else {
                const err = await response.json();
                alert('Ошибка при отправке: ' + JSON.stringify(err));
            }
        }

        document.getElementById('send-message').onclick = sendMessage;
        window.onload = loadChats;
    </script>
</body>
</html>

