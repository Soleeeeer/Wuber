<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ß–∞—Ç</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f2f4f7;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 20px;
        }
        h2 {
            color: #333;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        input, select, button {
            padding: 10px;
            margin: 5px 0;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
        }
        button {
            background-color: #22c55e;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #16a34a;
        }
        ul {
            list-style: none;
            padding: 0;
        }
        li {
            background: #e5f7eb;
            border: 1px solid #b2e0c0;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
            position: relative;
        }
        .message-actions {
            position: absolute;
            right: 10px;
            top: 10px;
            display: flex;
            gap: 6px;
        }
        .message-actions button {
            background-color: transparent;
            border: none;
            color: #555;
            font-size: 12px;
            cursor: pointer;
        }
        .message-actions button:hover {
            color: #000;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="section">
        <h2>–°–æ–∑–¥–∞—Ç—å —á–∞—Ç</h2>
        <select id="chat-type">
            <option value="private">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π</option>
            <option value="group">–ì—Ä—É–ø–ø–æ–≤–æ–π</option>
        </select>
        <input type="text" id="chat-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞ (–¥–ª—è –≥—Ä—É–ø–ø—ã)">
        <input type="text" id="participant-ids" placeholder="ID —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é">
        <button onclick="createChat()">–°–æ–∑–¥–∞—Ç—å —á–∞—Ç</button>
    </div>

    <div class="section">
        <h2>–°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤</h2>
        <ul id="chat-list"></ul>
    </div>

    <div class="section">
        <h2>–°–æ–æ–±—â–µ–Ω–∏—è</h2>
        <ul id="message-list"></ul>
        <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
        <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
</div>

<script>
    let currentChatId = null;

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    async function createChat() {
        const chatType = document.getElementById('chat-type').value;
        const name = document.getElementById('chat-name').value;
        const idsRaw = document.getElementById('participant-ids').value;
        const participant_ids = idsRaw.split(',').map(id => parseInt(id.trim())).filter(Boolean);

        const data = { chat_type: chatType, participant_ids };
        if (chatType === 'group') data.name = name;

        const response = await fetch('/api/chats/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            credentials: 'same-origin',
            body: JSON.stringify(data)
        });

        if (response.ok) {
            await loadChats();
            alert("–ß–∞—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω");
        } else {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏");
        }
    }

    async function loadChats() {
        const res = await fetch('/api/chats/', { credentials: 'same-origin' });
        const data = await res.json();
        const list = document.getElementById('chat-list');
        list.innerHTML = '';
        data.forEach(chat => {
            const li = document.createElement('li');
            li.textContent = chat.name || `–ß–∞—Ç #${chat.id}`;
            li.onclick = () => loadMessages(chat.id);
            list.appendChild(li);
        });
    }

   async function loadChats() {
    const res = await fetch('/api/chats/', { credentials: 'same-origin' });
    const data = await res.json();
    const list = document.getElementById('chat-list');
    list.innerHTML = '';
    data.forEach(chat => {
        const li = document.createElement('li');

        // –ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞
        const chatName = document.createElement('span');
        chatName.textContent = chat.name || `–ß–∞—Ç #${chat.id}`;
        chatName.style.cursor = 'pointer';
        chatName.onclick = () => loadMessages(chat.id);
        li.appendChild(chatName);

        // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
        const actions = document.createElement('div');
        actions.style.display = 'inline-block';
        actions.style.marginLeft = '10px';

        const editBtn = document.createElement('button');
        editBtn.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
        editBtn.onclick = () => editChat(chat);
        actions.appendChild(editBtn);

        // –ö–Ω–æ–ø–∫–∞ –£–¥–∞–ª–∏—Ç—å —á–∞—Ç
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
        deleteBtn.onclick = async (e) => {
            e.stopPropagation();
            if (confirm(`–£–¥–∞–ª–∏—Ç—å —á–∞—Ç "${chat.name || chat.id}"?`)) {
                const res = await fetch(`/api/chats/${chat.id}/`, {
                    method: 'DELETE',
                    headers: { 'X-CSRFToken': getCookie('csrftoken') },
                    credentials: 'same-origin'
                });
                if (res.ok) {
                    alert('–ß–∞—Ç —É–¥–∞–ª—ë–Ω');
                    await loadChats();
                    if (currentChatId === chat.id) {
                        currentChatId = null;
                        document.getElementById('message-list').innerHTML = '';
                    }
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —á–∞—Ç–∞');
                }
            }
        };
            actions.appendChild(deleteBtn);

            li.appendChild(actions);
            list.appendChild(li);
        });
    }

    async function loadMessages(chatId) {
    currentChatId = chatId;
    const res = await fetch(`/api/messages/?chat=${chatId}`, { credentials: 'same-origin' });
    if (!res.ok) {
        alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π");
        return;
    }
    const messages = await res.json();
    const list = document.getElementById('message-list');
    list.innerHTML = '';

    messages.forEach(msg => {
        const li = document.createElement('li');
        li.textContent = msg.content;

        // –ö–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, —É–¥–∞–ª–µ–Ω–∏—è –∏ –ø–µ—Ä–µ—Å—ã–ª–∫–∏
        const actions = document.createElement('div');
        actions.className = 'message-actions';

        const editBtn = document.createElement('button');
        editBtn.textContent = '‚úé';
        editBtn.onclick = () => editMessage(msg.id, msg.content);
        actions.appendChild(editBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'üóë';
        deleteBtn.onclick = () => deleteMessage(msg.id);
        actions.appendChild(deleteBtn);

        const forwardBtn = document.createElement('button');
        forwardBtn.textContent = '‚ûî';
        forwardBtn.onclick = () => forwardMessage(msg.id);
        actions.appendChild(forwardBtn);

        li.appendChild(actions);

        list.appendChild(li);
    });
}



    async function sendMessage() {
        const content = document.getElementById('message-input').value;
        if (!content.trim() || !currentChatId) return;

        const res = await fetch('/api/messages/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin',
            body: JSON.stringify({ chat: currentChatId, content })
        });

        if (res.ok) {
            document.getElementById('message-input').value = '';
            await loadMessages(currentChatId);
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ');
        }
    }

    async function deleteMessage(id) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?")) return;

        await fetch(`/api/messages/${id}/`, {
            method: 'DELETE',
            headers: { 'X-CSRFToken': getCookie('csrftoken') },
            credentials: 'same-origin',
        });
        await loadMessages(currentChatId);
    }

    async function editMessage(id, oldContent) {
        const newContent = prompt("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ:", oldContent);
        if (!newContent || newContent === oldContent) return;

        await fetch(`/api/messages/${id}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            credentials: 'same-origin',
            body: JSON.stringify({ content: newContent })
        });

        await loadMessages(currentChatId);
    }

    async function forwardMessage(id) {
        const chatId = prompt("–í –∫–∞–∫–æ–π —á–∞—Ç –ø–µ—Ä–µ—Å–ª–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ? –í–≤–µ–¥–∏—Ç–µ ID —á–∞—Ç–∞:");
        if (!chatId) return;

        await fetch(`/api/messages/${id}/forward/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin',
            body: JSON.stringify({ chat: parseInt(chatId) })
        });

        alert("–°–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ—Å–ª–∞–Ω–æ");
    }

    function editChat(chat) {
    const newName = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞:", chat.name || '');
    if (newName === null) return; // –æ—Ç–º–µ–Ω–∞
    if (!newName.trim()) {
        alert("–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º");
        return;
    }

    fetch(`/api/chats/${chat.id}/`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
        },
        credentials: 'same-origin',
        body: JSON.stringify({ name: newName })
    })
    .then(res => {
        if (res.ok) {
            alert('–ß–∞—Ç –æ–±–Ω–æ–≤–ª—ë–Ω');
            loadChats();
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —á–∞—Ç–∞');
        }
    });
}


    // –ó–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.onload = loadChats;
</script>
</body>
</html>



